# SIEVE — Synthetic Inspection, Editing & Validation Engine

A local review UI for human-in-the-loop validation of synthetic Q&A datasets generated by the RAG Evaluation Framework's `synthetic_datagen` module.

**Predecessor:** SAGE Review Tool (single-citation only, hardcoded paths, limited filtering).
**Companion:** [`rag-evaluation-framework/synthetic_datagen`](https://github.com/ankitvashisht12/rag-evaluation-framework) (generates the data SIEVE reviews).

---

## What SIEVE Does

SIEVE takes the `output.jsonl` produced by `synthetic_datagen.GenerationPipeline`, lets a human reviewer inspect every query-citation pair against the original KB documents, edit/add/remove citations, accept or reject items, add notes, and upload the approved dataset to LangSmith for evaluation.

### Key Differences from SAGE

| Aspect | SAGE | SIEVE |
|--------|------|-------|
| KB loading | Hardcoded path in backend config | User selects KB folder via native macOS picker or manual path |
| File format | Single citation per item | Multi-citation per item (`citations[]` array) |
| Citation editing | Override single citation from current doc only | Add citations from any KB doc, remove individual citations |
| Filtering | Status filter + text search | Status filter with virtualized item list |
| Data source | Auto-reads from sibling `output.jsonl` | User selects the output.jsonl file |
| Architecture | Python FastAPI + Next.js | Full-stack Next.js (API routes + React frontend) |

---

## Core Workflow

```
1. LOAD
   User opens SIEVE -> prompted to:
   +-- Select KB folder (directory of .md files) via Browse or manual path
   +-- Select output.jsonl (synthetic data to review)
   +-- Click "Start Review"

2. REVIEW
   Three-panel layout:
   +-- Left:   Item list with status filters (All/Pending/Accepted/Rejected)
   +-- Center: Detail panel (query, citations, classification, notes, actions)
   +-- Right:  KB document viewer with citation highlighting

3. EXPORT
   +-- Download review.jsonl (items with review decisions)
   +-- Upload accepted items to LangSmith
```

---

## Data Model

### Input: `output.jsonl`

Each line is a JSON object:

```json
{
  "query": "how much does the pro plan cost?",
  "citations": [
    {
      "doc_id": "pricing",
      "citation_text": "**Pro Plan** - $29/month",
      "span_start": 245,
      "span_end": 269,
      "chunks": ["Full pricing section..."]
    }
  ],
  "category": "pricing",
  "language": "en",
  "tone": "casual",
  "style": "question",
  "has_typos": false
}
```

### Output: `review.jsonl`

Same structure plus review fields:

```json
{
  "...all input fields...",
  "status": "accepted",
  "reviewer_notes": "Citation is accurate",
  "citations_modified": true,
  "query_modified": false,
  "original_query": null
}
```

---

## UI Layout

### Setup Screen

Clean landing page with two inputs (pre-filled with default paths):

- **KB Folder**: Select a directory containing `.md` files. Shows count after loading.
- **Output File**: Select an `output.jsonl` file. Shows count after loading.
- **Browse buttons**: Open native macOS file/folder picker via `osascript`.

Session persists across page refreshes (auto-restored from server state).

### Review Screen

#### Top Toolbar
- Title, progress stats (`X/Y reviewed`), accept/reject/pending counts
- Progress bar (green for accepted, red for rejected)
- **Load Data**: Open modal to switch KB/output files mid-session
- **Export**: Download `review.jsonl`
- **Upload**: Push accepted items to LangSmith

#### Left Panel — Item List (collapsible sidebar)
- Status filter buttons: All | Pending | Accepted | Rejected
- Virtualized item list with status dots, query preview, category badges
- Collapse/expand toggle button on the divider

#### Center Panel — Detail
- **Query**: Full text with AI rewrite option
- **Citations**: Cards showing doc_id, span, text preview, chunks. Click to highlight in source. Remove with X button.
- **Add Citation**: Enter selection mode, select text in source viewer, confirm
- **Classification**: Category and metadata display
- **Reviewer Notes**: Auto-saving textarea (500ms debounce)
- **Actions**: Accept (a) / Reject (r) / Reset

#### Right Panel — Source Viewer
- Document selector dropdown (switch between KB docs)
- Raw / Preview (markdown) toggle
- Citation spans highlighted with distinct colors
- Auto-scrolls to active citation
- Selection mode for adding new citations

---

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `j` / `Down` | Next item |
| `k` / `Up` | Previous item |
| `a` | Accept current item |
| `r` | Reject current item |
| `n` | Focus reviewer notes |
| `/` | Focus search |
| `Escape` | Exit selection mode / blur input |

---

## Tech Stack

- **Framework**: Next.js 16 (App Router) — both frontend and API routes
- **Language**: TypeScript (strict)
- **Styling**: Tailwind CSS v4, dark green theme (`#080f0b` base)
- **UI Components**: shadcn/ui (new-york style)
- **State Management**: Zustand
- **List Virtualization**: @tanstack/react-virtual
- **Markdown Rendering**: react-markdown + remark-gfm
- **Font**: IBM Plex Mono
- **Package Manager**: pnpm
- **Server State**: In-memory singleton (module-level, persists across requests)
- **Persistence**: Atomic JSONL write via temp file + rename
- **Native Dialogs**: `osascript` for macOS file/folder pickers

---

## API Endpoints

All endpoints are Next.js API routes under `src/app/api/`.

### Data Loading

| Method | Route | Description |
|--------|-------|-------------|
| `POST` | `/api/load/kb` | Load KB folder (`.md` files). Body: `{ path }` |
| `POST` | `/api/load/output` | Load output JSONL. Body: `{ path }`. Creates `review.jsonl` sibling |
| `GET` | `/api/session` | Check if server has an active session (for restore on refresh) |

### Review Operations

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/items` | Get all review items |
| `PATCH` | `/api/items/[index]` | Update item (status, notes, citations, query) |
| `GET` | `/api/kb/[docId]` | Get KB document content (frontmatter stripped) |
| `GET` | `/api/filters` | Get available filter values from loaded data |

### Citation & AI

| Method | Route | Description |
|--------|-------|-------------|
| `POST` | `/api/citation/compute` | Compute span indices for selected text |
| `POST` | `/api/ai/rewrite` | AI-powered query rewrite |

### Export & Upload

| Method | Route | Description |
|--------|-------|-------------|
| `GET` | `/api/export` | Download `review.jsonl` |
| `POST` | `/api/upload` | Upload accepted items to LangSmith |

### Utilities

| Method | Route | Description |
|--------|-------|-------------|
| `POST` | `/api/dialog` | Open native macOS file/folder picker. Body: `{ type: "folder" \| "file" }` |

---

## File Structure

```
sieve/
+-- src/
|   +-- app/
|   |   +-- page.tsx                    # Entry point (setup vs review screen)
|   |   +-- layout.tsx                  # Root layout, fonts, metadata
|   |   +-- globals.css                 # Dark theme, CSS variables, scrollbars
|   |   +-- api/                        # 12 API route handlers
|   |       +-- load/{kb,output}/
|   |       +-- items/  items/[index]/
|   |       +-- kb/[docId]/
|   |       +-- citation/compute/
|   |       +-- ai/rewrite/
|   |       +-- dialog/  session/  export/  filters/  upload/
|   +-- components/
|   |   +-- SetupScreen.tsx             # KB/output file picker with Browse buttons
|   |   +-- ReviewScreen.tsx            # Three-panel flex layout
|   |   +-- Toolbar.tsx                 # Top bar with stats, progress, actions
|   |   +-- Sidebar.tsx                 # Virtualized item list
|   |   +-- FilterBar.tsx               # Status filter buttons
|   |   +-- ItemRow.tsx                 # Single item row in sidebar
|   |   +-- DetailPanel.tsx             # Center: query, citations, notes, actions
|   |   +-- CitationCard.tsx            # Citation display with remove action
|   |   +-- AddCitationButton.tsx       # Triggers text selection mode
|   |   +-- CitationOverride.tsx        # Floating "Add as Citation" on text select
|   |   +-- SourceViewer.tsx            # Right: KB doc with citation highlights
|   |   +-- DocumentSelector.tsx        # Dropdown to switch KB documents
|   |   +-- CollapsibleSection.tsx      # Expandable UI section
|   |   +-- MetadataBadges.tsx          # Classification metadata display
|   |   +-- QueryRewriteDialog.tsx      # AI rewrite modal
|   |   +-- LoadDataModal.tsx           # Switch KB/output mid-session
|   |   +-- UploadModal.tsx             # LangSmith upload dialog
|   |   +-- KeyboardHandler.tsx         # Global keyboard shortcuts
|   |   +-- ui/                         # 12 shadcn/ui components
|   +-- lib/
|   |   +-- types.ts                    # TypeScript type definitions
|   |   +-- api.ts                      # Client-side API helpers
|   |   +-- serverStore.ts              # In-memory server state singleton
|   |   +-- persistence.ts              # Atomic JSONL file writes
|   |   +-- computeSpan.ts             # Citation span computation
|   |   +-- colors.ts                   # Citation color palette
|   |   +-- utils.ts                    # cn() utility for class merging
|   +-- stores/
|       +-- reviewStore.ts              # Zustand store (items, filters, actions)
+-- package.json
+-- tsconfig.json
+-- next.config.ts
+-- components.json                     # shadcn/ui config
+-- project.md                          # Original design document
```

---

## Getting Started

```bash
# Install dependencies
pnpm install

# Run dev server
pnpm dev
```

Open [http://localhost:3000](http://localhost:3000), select your KB folder and output.jsonl, and start reviewing.

---

## Multi-Citation Workflow

### Viewing Citations
- Center panel lists all citations as cards
- Click a card to scroll the source viewer to that span with color highlighting
- Multiple citations from the same doc show as distinct colored highlights

### Adding a Citation
1. Click "+ Add Citation" in the center panel
2. Source viewer enters selection mode (cyan indicator bar)
3. Select text in the document
4. Click the floating "Add as Citation" button
5. Span is computed server-side and citation is appended

### Removing a Citation
- Click the X button on any citation card
- `citations_modified` flag is set automatically

### Editing a Citation
- Remove the old citation, then add a new one via text selection
- This ensures span indices are always computed correctly
